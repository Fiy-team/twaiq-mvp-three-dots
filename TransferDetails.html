<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>تفاصيل العملية - نظام أمن التحويلات</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'absher-green': '#006C3A',
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div class="absher-header">
        <div class="container px-4">
            <div class="logo">تفاصيل عملية التحويل</div>
        </div>
    </div>

    <div class="container py-8">
        <a href="AbsherDashboard.html" class="text-gray-500 mb-6 block hover:underline text-sm"><i class="fas fa-arrow-right ml-1"></i> العودة للوحة القيادة</a>

        <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-absher-green mb-8">
            <h2 class="text-2xl font-bold mb-4 text-absher-green flex items-center"><i class="fas fa-receipt ml-2"></i> تفاصيل العملية: <span id="tx-id" class="mr-2">...</span></h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 text-gray-700">
                <div class="col-span-1"><span class="font-semibold">المبلغ:</span> <span id="tx-amount">...</span> SAR</div>
                <div class="col-span-1"><span class="font-semibold">المستفيد:</span> <span id="tx-receiver">...</span></div>
                <div class="col-span-1"><span class="font-semibold">هوية المرسل:</span> <span id="tx-profile-id">...</span></div>
                <div class="col-span-1"><span class="font-semibold">نوع التحويل:</span> <span id="tx-type">...</span></div>
                <div class="col-span-2"><span class="font-semibold">تاريخ ووقت العملية:</span> <span id="tx-time">...</span></div>
            </div>
            <div class="mt-4 p-3 rounded-lg border" id="tx-status-display">
                <span class="font-bold">الحالة الحالية:</span> <span id="tx-status" class="ml-2">...</span>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-red-600 mb-8">
            <h2 class="text-2xl font-bold mb-4 text-red-700 flex items-center"><i class="fas fa-brain ml-2"></i> تحليل الذكاء الاصطناعي والمخاطر</h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div><span class="font-semibold">الخطورة المحتسبة:</span> <span id="risk-score" class="ml-2 font-bold text-lg">...%</span></div>
                <div><span class="font-semibold">مستوى الخطورة:</span> <span id="risk-level" class="ml-2 font-bold text-lg">...</span></div>
            </div>

            <div class="p-4 bg-gray-50 rounded-lg border mb-6">
                <span class="font-semibold text-gray-700">توصية الذكاء الاصطناعي:</span>
                <p class="font-bold text-red-800 mt-1" id="ai-action">...</p>
                <p class="text-sm text-gray-600 mt-2" id="short-reason">...</p>
            </div>

            <h3 class="text-xl font-bold text-gray-800 mb-3 flex items-center"><i class="fas fa-flag ml-2"></i> سجل البلاغات على المستفيد: <span id="reports-count-summary" class="mr-1"></span></h3>
            <div class="space-y-2 border p-3 rounded-lg" id="reports-list">
                </div>
        </div>
        
        <div class="bg-white p-6 rounded-lg shadow-xl border-t-4 border-blue-500">
            <h2 class="text-2xl font-bold mb-4 text-blue-700 flex items-center"><i class="fas fa-gavel ml-2"></i> الإجراءات الإدارية</h2>
            <p class="mb-4 text-gray-700">اتخاذ القرار النهائي بشأن العملية:</p>

            <div class="flex flex-wrap gap-4">
                <button id="approve-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition flex items-center"><i class="fas fa-check ml-2"></i> قبول العملية</button>
                <button id="reject-btn" class="bg-red-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-red-700 transition flex items-center"><i class="fas fa-times ml-2"></i> رفض العملية</button>
                <button id="freeze-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition flex items-center"><i class="fas fa-snowflake ml-2"></i> تجميد مؤقت</button>
                <button id="report-btn" class="bg-orange-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-700 transition flex items-center"><i class="fas fa-exclamation-triangle ml-2"></i> رفع تقرير إجباري</button>
            </div>
            
            <div class="mt-6 p-3 bg-gray-100 rounded-lg text-sm text-gray-700" id="action-message">
                
            </div>
        </div>

    </div>

    <script type="module">
        import { getTransactionById, updateTransactionStatus, ReportTypes } from './mockDatabase.js';

        // دالة مساعدة لتحديد لون حالة العملية
        function getStatusColorClass(status) {
            switch(status) {
                case 'PENDING_AI': return 'bg-yellow-200 text-yellow-900 border-yellow-500';
                case 'FROZEN': return 'bg-blue-200 text-blue-900 border-blue-500';
                case 'APPROVED': return 'bg-green-200 text-green-900 border-green-500';
                case 'REJECTED': 
                case 'REPORTED': return 'bg-red-200 text-red-900 border-red-500';
                default: return 'bg-gray-200 text-gray-900 border-gray-500';
            }
        }
        
        // دالة جلب نوع البلاغ من القائمة الأساسية
        function getReportTypeLabel(reportId) {
            const report = ReportTypes.find(r => r.id === reportId);
            return report ? report.label : 'بلاغ غير معروف';
        }

        // دالة عرض البلاغات التفصيلية
        function renderReports(tx) {
            const reportsList = document.getElementById('reports-list');
            reportsList.innerHTML = '';
            
            const summary = document.getElementById('reports-count-summary');
            
            if (!tx.reportsData || tx.reportsData.length === 0 || tx.reportsCount === 0) {
                reportsList.innerHTML = `<p class="text-green-600 font-semibold">لا توجد بلاغات مسجلة ضد هذا المستفيد حالياً.</p>`;
                summary.textContent = `(0 بلاغ)`;
                return;
            }
            
            summary.textContent = `(${tx.reportsCount} بلاغ)`;
            
            tx.reportsData.forEach(reportEntry => {
                if (reportEntry.count > 0) {
                    const reportLabel = getReportTypeLabel(reportEntry.id);
                    const reportItem = document.createElement('div');
                    reportItem.className = 'flex justify-between items-center p-2 bg-red-50 border-r-4 border-red-500';
                    reportItem.innerHTML = `
                        <span class="font-semibold text-gray-800">${reportLabel}</span>
                        <span class="text-red-700 font-bold">${reportEntry.count} مرات</span>
                    `;
                    reportsList.appendChild(reportItem);
                }
            });
        }

        function loadTransactionDetails() {
            const urlParams = new URLSearchParams(window.location.search);
            const txId = urlParams.get('id');

            if (!txId) {
                document.getElementById('tx-id').textContent = 'خطأ في جلب الهوية';
                return;
            }

            const tx = getTransactionById(txId);
            if (!tx) {
                document.getElementById('tx-id').textContent = `العملية رقم ${txId} غير موجودة.`;
                return;
            }

            // عرض تفاصيل العملية
            document.getElementById('tx-id').textContent = tx.id;
            document.getElementById('tx-amount').textContent = tx.amount.toLocaleString();
            document.getElementById('tx-receiver').textContent = tx.receiver;
            document.getElementById('tx-profile-id').textContent = tx.profileId;
            document.getElementById('tx-type').textContent = tx.type;
            document.getElementById('tx-time').textContent = new Date(tx.time).toLocaleString('ar-SA');
            
            const statusDisplay = document.getElementById('tx-status-display');
            document.getElementById('tx-status').textContent = tx.status;
            statusDisplay.className = `mt-4 p-3 rounded-lg border ${getStatusColorClass(tx.status)}`;

            // عرض تحليل الذكاء الاصطناعي
            document.getElementById('risk-score').textContent = tx.riskScore;
            document.getElementById('risk-level').textContent = tx.riskLevel;
            document.getElementById('ai-action').textContent = tx.aiAction;
            document.getElementById('short-reason').textContent = tx.shortReason.ar;
            
            // عرض نظام البلاغات التفصيلي
            renderReports(tx);
            
            // تهيئة الأزرار
            setupActionButtons(tx.id);
        }
        
        function setupActionButtons(txId) {
            const messageElement = document.getElementById('action-message');
            
            const handleAction = (status, actionType) => {
                if (confirm(`هل أنت متأكد من تغيير حالة العملية ${txId} إلى ${actionType}؟`)) {
                    if (updateTransactionStatus(txId, status, actionType)) {
                        messageElement.innerHTML = `<i class="fas fa-check-circle ml-1 text-green-600"></i> تم تحديث العملية بنجاح إلى: <strong>${actionType}</strong>.`;
                        // إعادة تحميل التفاصيل لرؤية التغيير في الحالة
                        loadTransactionDetails();
                    } else {
                        messageElement.innerHTML = `<i class="fas fa-exclamation-circle ml-1 text-red-600"></i> فشل تحديث العملية.`;
                    }
                }
            };
            
            document.getElementById('approve-btn').addEventListener('click', () => handleAction('APPROVED', 'قبول يدوي'));
            document.getElementById('reject-btn').addEventListener('click', () => handleAction('REJECTED', 'رفض يدوي'));
            document.getElementById('freeze-btn').addEventListener('click', () => handleAction('FROZEN', 'تجميد إداري'));
            document.getElementById('report-btn').addEventListener('click', () => handleAction('REPORTED', 'رفع تقرير'));
        }

        document.addEventListener('DOMContentLoaded', loadTransactionDetails);
    </script>
</body>
</html>
